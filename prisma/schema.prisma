// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())
  name          String
  email         String     @unique
  passwordHash  String
  phone         String?
  image         String?    // Profile photo URL or base64
  role          String     @default("USER") // "ADMIN" or "USER"
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  bookings      Booking[]
  tenantProfile TenantProfile?

  @@index([email])
}

model Kost {
  id               String   @id @default(cuid())
  name             String
  address          String
  city             String
  description      String   @db.Text
  rules            String   @db.Text
  facilities       String   @default("[]") // JSON array
  contactPhone     String
  contactWhatsApp  String
  email            String
  coverImageUrl    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  rooms            Room[]
}

model Owner {
  id        String   @id @default(cuid())
  name      String
  photoUrl  String?
  bio       String   @db.Text
  phone     String
  email     String
  socials   String   @default("{}") // JSON object
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Room {
  id            String   @id @default(cuid())
  kostId        String
  slug          String   @unique
  name          String
  size          String   // e.g., "3x4m"
  floor         Int
  capacity      Int
  facilities    String   @default("[]") // JSON array
  isAvailable   Boolean  @default(true)
  mainImageUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  kost          Kost     @relation(fields: [kostId], references: [id], onDelete: Cascade)
  images        RoomImage[]
  prices        Price[]
  bookings      Booking[]

  @@index([kostId])
  @@index([slug])
}

model RoomImage {
  id        String   @id @default(cuid())
  roomId    String
  url       String
  alt       String?
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
}

model Price {
  id        String   @id @default(cuid())
  roomId    String
  period    String   // "MONTH", "6MO", "12MO"
  amount    Int      // in rupiah
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, period])
  @@index([roomId])
}

model Booking {
  id         String   @id @default(cuid())
  userId     String
  roomId     String
  startDate  DateTime
  endDate    DateTime
  period     String   // "MONTH", "6MO", "12MO"
  totalPrice Int      // in rupiah
  status     String   @default("PENDING") // "PENDING", "CONFIRMED", "CANCELLED"
  notes      String?
  paymentId  String?  // Reference to Payment
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  room       Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  payment    Payment?

  @@index([userId])
  @@index([roomId])
  @@index([status])
  @@index([paymentId])
}

model Payment {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  orderId       String   @unique // Midtrans order_id
  transactionId String?  // Midtrans transaction_id
  paymentType   String?  // payment method type
  status        String   @default("pending") // "pending", "settlement", "cancel", "expire", "deny"
  grossAmount   Int      // in rupiah
  token         String?  // Snap token
  snapToken     String?  // Snap payment token
  fraudStatus   String?  // Midtrans fraud status
  vaNumber      String?  // Virtual account number
  bank          String?  // Bank name for VA
  paymentCode   String?  // Payment code
  expiryTime    DateTime? // Payment expiry time
  metadata      String?  @db.Text // JSON string for additional data
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([orderId])
  @@index([status])
}

model TenantProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  ktpNumber        String?
  emergencyContact String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
